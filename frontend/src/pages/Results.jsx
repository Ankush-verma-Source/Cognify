import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    ArrowLeft, Download, Copy, Share2,
    CheckCircle2, XCircle, Info, ChevronRight,
    Brain, FileText, ListChecks, Code2, Layers, Loader2, BarChart2,
    TrendingUp, TrendingDown, DollarSign, Users, Box, Calendar, Activity
} from 'lucide-react';
import api from '../api/axios';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import {
    ResponsiveContainer, BarChart, Bar, LineChart, Line,
    AreaChart, Area, PieChart, Pie, Cell, XAxis, YAxis,
    CartesianGrid, Tooltip, Legend,
    RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar,
    ScatterChart, Scatter, ComposedChart, FunnelChart, Funnel, Treemap
} from 'recharts';

const Results = () => {
    const { id } = useParams();
    const navigate = useNavigate();
    const [isLoading, setIsLoading] = useState(true);
    const [isExporting, setIsExporting] = useState(false);
    const [content, setContent] = useState(null);
    const [error, setError] = useState('');
    const contentRef = React.useRef(null);

    useEffect(() => {
        const fetchContent = async () => {
            try {
                const response = await api.get(`/dashboard/view/${id}`);
                if (response.data.success) {
                    setContent(response.data.content);
                }
            } catch (err) {
                console.error("Failed to fetch content", err);
                setError(err.response?.data?.error || "Failed to load results.");
            } finally {
                setIsLoading(false);
            }
        };

        if (id) fetchContent();
    }, [id]);

    const handleCopy = () => {
        const text = JSON.stringify(content.data, null, 2);
        navigator.clipboard.writeText(text);
        alert("Content copied to clipboard!");
    };

    const handleExport = () => {
        setIsExporting(true);
        try {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            let yPos = 20;

            // Helper to check page break
            const checkPageBreak = (heightNeeded) => {
                if (yPos + heightNeeded >= pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                }
            };

            // Helper to add text with wrapping
            const addWrappedText = (text, fontSize = 12, fontStyle = 'normal', color = [0, 0, 0]) => {
                if (!text) return;
                doc.setFontSize(fontSize);
                doc.setFont("helvetica", fontStyle);
                doc.setTextColor(...color);

                const lines = doc.splitTextToSize(String(text), contentWidth);
                const lineHeight = fontSize * 0.5; // roughly convert pts to mm approx

                checkPageBreak(lines.length * lineHeight + 5);

                doc.text(lines, margin, yPos);
                yPos += (lines.length * lineHeight) + 4;
            };

            // Helper to add a separator line
            const addSeparator = () => {
                checkPageBreak(10);
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
            };

            // --- HEADER ---
            doc.setFontSize(22);
            doc.setTextColor(0, 0, 0);
            doc.text(`${content.type.toUpperCase().replace('-', ' ')} RESULT`, margin, yPos);
            yPos += 10;

            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated by: ${content.meta?.model || 'AI Model'}`, margin, yPos);
            yPos += 6;
            doc.text(`Date: ${new Date(content.createdAt).toLocaleDateString()}`, margin, yPos);
            yPos += 15;

            addSeparator();

            // --- CONTENT HANDLERS ---

            // 1. MCQ & QUIZ
            if (content.type === 'mcq' || content.type === 'quiz') {
                const mcqs = Array.isArray(content.data) ? content.data : [];
                mcqs.forEach((q, idx) => {
                    checkPageBreak(40); // Estimate minimum space for a question

                    addWrappedText(`Q${idx + 1}: ${q.question}`, 14, 'bold');

                    if (Array.isArray(q.options)) {
                        q.options.forEach((opt, i) => {
                            const letter = String.fromCharCode(65 + i);
                            const isCorrect = letter === q.correct;
                            const prefix = isCorrect ? '[✓] ' : '[ ] ';
                            const color = isCorrect ? [0, 150, 0] : [80, 80, 80];
                            addWrappedText(`${letter}) ${opt}`, 12, isCorrect ? 'bold' : 'normal', color);
                        });
                    } else if (q.answer) {
                        addWrappedText(`Answer: ${q.answer}`, 12, 'italic', [0, 100, 0]);
                    }

                    if (q.explanation) {
                        yPos += 2;
                        addWrappedText(`Explanation: ${q.explanation}`, 10, 'italic', [100, 100, 100]);
                    }

                    yPos += 8;
                });
            }

            // 2. FLASHCARDS
            else if (content.type === 'flashcards') {
                const cards = Array.isArray(content.data) ? content.data : [];
                cards.forEach((card, idx) => {
                    checkPageBreak(40);
                    // Draw box styling simulation
                    doc.setFillColor(245, 247, 250);
                    doc.roundedRect(margin, yPos, contentWidth, 35, 3, 3, 'F');

                    let tempY = yPos + 8;
                    // Mock context switch for internal text
                    const currentY = yPos;
                    yPos = tempY;

                    addWrappedText(`Front: ${card.question}`, 12, 'bold');
                    addWrappedText(`Back: ${card.answer}`, 12, 'normal', [0, 0, 150]);

                    yPos = currentY + 40; // Advance past box
                });
            }

            // 3. SUMMARY
            else if (content.type === 'summary') {
                const text = typeof content.data === 'string' ? content.data : JSON.stringify(content.data);
                addWrappedText(text, 12, 'normal');
            }

            // 4. CODE TOOLS (Explain / Review)
            else if (content.type === 'explain' || content.type === 'review') {
                const data = content.data;
                if (data.summary) {
                    addWrappedText("Executive Summary", 16, 'bold');
                    addWrappedText(String(data.summary));
                    yPos += 5;
                }

                if (Array.isArray(data.functions)) {
                    data.functions.forEach(fn => {
                        addSeparator();
                        addWrappedText(`Function: ${fn.name}`, 14, 'bold', [0, 0, 180]);
                        addWrappedText(fn.description);

                        if (fn.correctness) {
                            yPos += 3;
                            addWrappedText(`Correctness: ${fn.correctness}`, 11, 'italic');
                        }

                        if (fn.potentialIssues && fn.potentialIssues.length) {
                            yPos += 3;
                            addWrappedText("Potential Issues:", 11, 'bold', [200, 100, 0]);
                            fn.potentialIssues.forEach(pi => addWrappedText(`- ${pi}`, 11));
                        }

                        if (fn.optimizations && fn.optimizations.length) {
                            yPos += 3;
                            addWrappedText("Optimizations:", 11, 'bold', [0, 150, 100]);
                            fn.optimizations.forEach(op => addWrappedText(`-> ${op}`, 11));
                        }
                    });
                }
            }

            // 5. DATA ANALYSIS & VISUALIZATION
            else if (content.type === 'analysis' || content.type === 'visualize') {
                const data = content.data || {};
                const title = content.type === 'visualize' ? "Visual Intelligence Dashboard" : "Advanced Data Analysis Report";
                addWrappedText(title, 18, 'bold');

                // Executive Summary
                const summaryText = data.scentific_summary || data.executive_summary || data.summary;
                if (summaryText) {
                    addWrappedText(String(summaryText));
                    yPos += 5;
                }

                // KPIs (New for Visualizer)
                if (data.kpis && data.kpis.length) {
                    addSeparator();
                    addWrappedText("Key Performance Indicators", 14, 'bold', [79, 70, 229]); // Indigo
                    data.kpis.forEach(k => {
                        addWrappedText(`• ${k.label}: ${k.value} (${k.change} ${k.trend})`, 11);
                    });
                    yPos += 8;
                }

                // Key Features (Only if exist)
                if (data.key_features && data.key_features.length) {
                    addWrappedText("Critical Drivers:", 12, 'bold', [100, 100, 100]);
                    const features = data.key_features.join(", ");
                    addWrappedText(features, 11, 'italic');
                    yPos += 8;
                }

                // Data Quality
                if (data.data_quality_audit) {
                    addSeparator();
                    addWrappedText(`Data Quality Score: ${data.data_quality_audit.score || 'N/A'}/100`, 14, 'bold', [0, 0, 150]);
                    addWrappedText(data.data_quality_audit.details || "Health check completed.", 11);
                    yPos += 5;
                }

                // Statistical Insights
                if (data.statistical_insights && data.statistical_insights.length) {
                    addSeparator();
                    addWrappedText("Statistical Deep Dive", 14, 'bold', [75, 0, 130]); // Indigo
                    data.statistical_insights.forEach(insight => {
                        addWrappedText(`• ${insight}`, 11);
                        yPos += 2;
                    });
                    yPos += 5;
                }

                // Market Trends
                const trends = data.market_trends?.details || data.trends || [];
                const trendsOverview = data.market_trends?.overview;

                if (trends.length || trendsOverview) {
                    addSeparator();
                    addWrappedText("Market Trends & Patterns", 14, 'bold', [0, 128, 128]); // Teal

                    if (trendsOverview) {
                        addWrappedText(trendsOverview, 11, 'italic');
                        yPos += 4;
                    }

                    trends.forEach(t => addWrappedText(`• ${t}`, 11));
                    yPos += 5;
                }

                // Segmentation
                if (data.segmentation_analysis) {
                    addSeparator();
                    addWrappedText("Segmentation Analysis", 14, 'bold', [0, 100, 200]);
                    addWrappedText(data.segmentation_analysis, 11);
                    yPos += 5;
                }

                // Anomalies
                if (data.anomalies && data.anomalies.length) {
                    addSeparator();
                    addWrappedText("Anomalies & Outliers", 14, 'bold', [200, 100, 0]); // Orange
                    data.anomalies.forEach(a => addWrappedText(`⚠ ${a}`, 11));
                    yPos += 5;
                }

                // Predictive Potential
                if (data.predictive_potential) {
                    addSeparator();
                    addWrappedText("Predictive Modeling Potential", 14, 'bold', [100, 50, 150]); // Purple
                    addWrappedText(`Feasibility: ${data.predictive_potential.feasibility || 'Evaluation Pending'}`, 12, 'bold');
                    addWrappedText(data.predictive_potential.details || "Evaluation of model applicability.", 11);

                    if (data.predictive_potential.recommended_models?.length) {
                        yPos += 3;
                        addWrappedText("Recommended Models: " + data.predictive_potential.recommended_models.join(", "), 11, 'italic');
                    }
                    yPos += 5;
                }

                // Visual Intelligence Summary (for PDF)
                if (data.visualizations && data.visualizations.length) {
                    addSeparator();
                    addWrappedText("Visual Dashboards Summary", 14, 'bold', [16, 185, 129]); // Emerald
                    data.visualizations.forEach(chart => {
                        addWrappedText(`Chart: ${chart.title}`, 11, 'bold');
                        addWrappedText(chart.description, 10, 'italic');
                        if (chart.data && chart.data.length) {
                            const dataStr = chart.data.map(d => `${d.name}: ${d.value}`).join(" | ");
                            addWrappedText(`Data: ${dataStr}`, 9);
                        }
                        yPos += 4;
                    });
                    yPos += 5;
                }

                // Recommendations
                if (data.recommendations && data.recommendations.length) {
                    addSeparator();
                    addWrappedText("Strategic Guidance", 16, 'bold', [0, 100, 0]); // Green
                    data.recommendations.forEach((r, i) => {
                        addWrappedText(`${i + 1}. ${r}`, 12, 'normal');
                        yPos += 3;
                    });
                }
            }

            // Save
            doc.save(`${content.type}-report.pdf`);

        } catch (error) {
            console.error("Export failed", error);
            alert("Failed to export PDF.");
        } finally {
            setIsExporting(false);
        }
    };

    if (isLoading) {
        return (
            <div className="min-h-screen bg-[#020617] flex items-center justify-center">
                <div className="flex flex-col items-center gap-4">
                    <Loader2 className="w-12 h-12 text-indigo-500 animate-spin" />
                    <p className="text-slate-400 animate-pulse">Retrieving your insights...</p>
                </div>
            </div>
        );
    }

    if (error || !content) {
        return (
            <div className="min-h-screen bg-[#020617] flex items-center justify-center p-6">
                <div className="text-center space-y-4">
                    <XCircle className="w-16 h-16 text-red-500 mx-auto opacity-50" />
                    <h2 className="text-2xl font-bold text-white">Oops! Something went wrong</h2>
                    <p className="text-slate-400">{error || "The content you're looking for doesn't exist."}</p>
                    <button onClick={() => navigate('/dashboard')} className="btn-primary mt-4">
                        Back to Dashboard
                    </button>
                </div>
            </div>
        );
    }

    const renderHeader = () => (
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
            <div className="flex items-center gap-4">
                <button
                    onClick={() => navigate('/dashboard?tab=overview')}
                    className="p-2 rounded-full bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white transition-colors"
                >
                    <ArrowLeft className="w-5 h-5" />
                </button>
                <div>
                    <h1 className="text-3xl font-bold text-white capitalize">{content.type.replace('-', ' ')} Result</h1>
                    <div className="flex items-center gap-3 mt-1">
                        <span className="text-xs font-medium px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-400 uppercase tracking-wider">
                            {content.meta?.model || 'AI Generated'}
                        </span>
                        <span className="text-xs text-slate-500">
                            {new Date(content.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                        </span>
                    </div>
                </div>
            </div>

            <div className="flex items-center gap-3 w-full md:w-auto">
                <button onClick={handleCopy} className="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 text-slate-300 rounded-lg transition-colors border border-white/10">
                    <Copy className="w-4 h-4" /> Copy JSON
                </button>
                <button
                    onClick={handleExport}
                    disabled={isExporting}
                    className="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-all shadow-lg shadow-indigo-500/20 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {isExporting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4" />}
                    {isExporting ? 'Exporting...' : 'Export PDF'}
                </button>
            </div>
        </div>
    );

    const renderMCQs = () => {
        const mcqs = Array.isArray(content.data) ? content.data : [];
        return (
            <div className="space-y-6">
                {mcqs.map((q, idx) => (
                    <div key={idx} className="bg-slate-900/40 border border-white/5 rounded-3xl p-6 md:p-8 backdrop-blur-sm">
                        <div className="flex items-start gap-4">
                            <div className="w-8 h-8 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center font-bold flex-shrink-0 text-sm">
                                {idx + 1}
                            </div>
                            <div className="flex-1">
                                <h3 className="text-lg font-semibold text-white mb-6 leading-relaxed">{q.question}</h3>
                                {Array.isArray(q.options) ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {q.options.map((opt, i) => {
                                            const optionLetter = String.fromCharCode(65 + i);
                                            const isCorrect = optionLetter === q.correct;
                                            return (
                                                <div
                                                    key={i}
                                                    className={`p-4 rounded-xl border transition-all ${isCorrect
                                                        ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400'
                                                        : 'bg-white/5 border-white/10 text-slate-300'
                                                        }`}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm">{opt}</span>
                                                        {isCorrect && <CheckCircle2 className="w-4 h-4" />}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl text-yellow-500 text-sm">
                                        {q.answer || q.correct || "No options available for this question."}
                                    </div>
                                )}
                                {q.explanation && (
                                    <div className="mt-6 p-4 bg-indigo-500/5 rounded-lg border border-indigo-500/10 flex gap-3">
                                        <Info className="w-5 h-5 text-indigo-400 flex-shrink-0" />
                                        <p className="text-sm text-slate-400 leading-relaxed">
                                            <span className="font-bold text-indigo-400">Context: </span>
                                            {q.explanation}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        );
    };

    const renderSummary = () => (
        <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 md:p-12 backdrop-blur-sm">
            <div className="flex items-center gap-3 mb-8">
                <FileText className="w-6 h-6 text-indigo-400" />
                <h2 className="text-2xl font-bold text-white">Generated Summary</h2>
            </div>
            <div className="prose prose-invert max-w-none">
                <p className="text-slate-300 text-lg leading-loose whitespace-pre-wrap">
                    {content.data}
                </p>
            </div>
        </div>
    );

    const renderFlashcards = () => {
        const cards = Array.isArray(content.data) ? content.data : [];
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {cards.map((card, idx) => (
                    <div key={idx} className="h-64 group [perspective:1000px]">
                        <div className="relative h-full w-full rounded-2xl shadow-xl transition-all duration-500 [transform-style:preserve-3d] group-hover:[transform:rotateY(180deg)] cursor-pointer">
                            {/* Front */}
                            <div className="absolute inset-0 p-6 flex flex-col justify-center items-center bg-slate-900 border border-white/10 rounded-2xl backface-hidden">
                                <Layers className="w-8 h-8 text-indigo-500 mb-4 opacity-50" />
                                <p className="text-center text-white font-medium text-lg leading-relaxed">{card.question}</p>
                                <span className="mt-auto text-[10px] text-slate-500 uppercase tracking-widest font-bold">Query</span>
                            </div>
                            {/* Back */}
                            <div className="absolute inset-0 h-full w-full rounded-2xl bg-indigo-600 p-6 text-center text-slate-100 [transform:rotateY(180deg)] [backface-visibility:hidden] flex flex-col justify-center items-center">
                                <Brain className="w-8 h-8 text-white/50 mb-4" />
                                <p className="text-lg leading-relaxed">{card.answer}</p>
                                <span className="mt-auto text-[10px] text-indigo-200 uppercase tracking-widest font-bold">Concept</span>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        );
    };

    const renderCodeAnalysis = () => {
        const data = content.data;
        return (
            <div className="space-y-8">
                <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                    <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <Code2 className="w-5 h-5 text-indigo-400" /> Executive Summary
                    </h2>
                    <p className="text-slate-300 leading-relaxed text-lg">
                        {typeof data.summary === 'string' ? data.summary : JSON.stringify(data.summary)}
                    </p>
                </div>

                {data.functions?.map((fn, idx) => (
                    <div key={idx} className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                        <h3 className="text-lg font-bold text-white mb-6 border-b border-white/5 pb-4 capitalize">{fn.name}</h3>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-4">
                                <h4 className="text-sm font-bold text-indigo-400 uppercase tracking-wider">Logic Breakdown</h4>
                                <p className="text-slate-400 text-sm leading-relaxed">{fn.description}</p>
                                <div className="p-4 bg-emerald-500/5 rounded-xl border border-emerald-500/10">
                                    <h5 className="text-xs font-bold text-emerald-400 uppercase mb-2">Correctness</h5>
                                    <p className="text-slate-300 text-xs">{fn.correctness}</p>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div>
                                    <h4 className="text-sm font-bold text-orange-400 uppercase tracking-wider mb-3">Potential Issues</h4>
                                    <ul className="space-y-2">
                                        {fn.potentialIssues?.map((issue, i) => (
                                            <li key={i} className="text-xs text-slate-400 flex gap-2">
                                                <span className="text-orange-500">•</span> {issue}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="text-sm font-bold text-indigo-400 uppercase tracking-wider mb-3">Suggested Optimizations</h4>
                                    <ul className="space-y-2">
                                        {fn.optimizations?.map((opt, i) => (
                                            <li key={i} className="text-xs text-slate-300 flex gap-2">
                                                <span className="text-indigo-500">→</span> {opt}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        );
    };



    const renderDataVisualizationDashboard = () => {
        const data = content.data || {};
        const { dashboard_title, kpis = [], visualizations = [] } = data;
        const scentific_summary = data.scentific_summary || data.executive_summary;
        const {
            data_quality_audit,
            market_trends,
            anomalies = [],
            recommendations = [],
            statistical_insights = [],
            segmentation_analysis
        } = data;

        const KPICard = ({ kpi }) => {
            const Icon = {
                dollar: DollarSign,
                users: Users,
                activity: Activity,
                'trending-up': TrendingUp,
                box: Box,
                calendar: Calendar,
                layers: Layers
            }[kpi.icon] || Activity;

            const isPositive = kpi.trend === 'up';
            const isNeutral = kpi.trend === 'neutral';

            return (
                <div className="bg-slate-900/60 border border-white/10 rounded-2xl p-6 backdrop-blur-xl relative overflow-hidden group hover:border-indigo-500/30 transition-all">
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-indigo-500/10 rounded-xl group-hover:bg-indigo-500/20 transition-colors">
                            <Icon className="w-6 h-6 text-indigo-400" />
                        </div>
                        <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded-full border ${isPositive ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : isNeutral ? 'bg-slate-500/10 text-slate-400 border-slate-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}>
                            {isPositive ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}
                            {kpi.change}
                        </div>
                    </div>
                    <div>
                        <p className="text-slate-400 text-sm font-medium mb-1">{kpi.label}</p>
                        <h3 className="text-3xl font-bold text-white tracking-tight">{kpi.value}</h3>
                    </div>
                </div>
            );
        };

        const renderChartContent = (chart) => {
            const colors = chart.colors || ["#6366f1", "#14b8a6", "#a855f7", "#ec4899", "#f59e0b"];
            const CommonTooltip = () => (
                <Tooltip
                    contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '12px', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }}
                    itemStyle={{ color: '#f8fafc', fontSize: '12px' }}
                    labelStyle={{ color: '#94a3b8', marginBottom: '8px' }}
                />
            );

            switch (chart.type) {
                case 'radar':
                    return (
                        <ResponsiveContainer width="100%" height="100%">
                            <RadarChart cx="50%" cy="50%" outerRadius="80%" data={chart.data}>
                                <PolarGrid stroke="#334155" />
                                <PolarAngleAxis dataKey="name" tick={{ fill: '#94a3b8', fontSize: 10 }} />
                                <PolarRadiusAxis angle={30} domain={[0, 'auto']} tick={{ fill: '#94a3b8', fontSize: 10 }} />
                                <Radar name={chart.title} dataKey="value" stroke={colors[0]} fill={colors[0]} fillOpacity={0.4} />
                                <Legend />
                                <CommonTooltip />
                            </RadarChart>
                        </ResponsiveContainer>
                    );
                case 'scatter':
                    return (
                        <ResponsiveContainer width="100%" height="100%">
                            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: -20 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#334155" opacity={0.5} />
                                <XAxis type="number" dataKey="x" name="X" stroke="#94a3b8" fontSize={10} tickLine={false} />
                                <YAxis type="number" dataKey="y" name="Y" stroke="#94a3b8" fontSize={10} tickLine={false} />
                                <CommonTooltip />
                                <Scatter name={chart.title} data={chart.data} fill={colors[0] || "#10b981"} />
                            </ScatterChart>
                        </ResponsiveContainer>
                    );
                case 'treemap':
                    return (
                        <ResponsiveContainer width="100%" height="100%">
                            <Treemap
                                data={chart.data}
                                dataKey="value"
                                aspectRatio={4 / 3}
                                stroke="#0f172a"
                                fill={colors[0] || "#6366f1"}
                                content={<CommonTooltip />}
                            />
                        </ResponsiveContainer>
                    );
                case 'pie':
                    return (
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={chart.data}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={60}
                                    outerRadius={80}
                                    paddingAngle={5}
                                    dataKey="value"
                                >
                                    {chart.data.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={colors[index % colors.length]} />
                                    ))}
                                </Pie>
                                <CommonTooltip />
                                <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '10px' }} />
                            </PieChart>
                        </ResponsiveContainer>
                    );
                default:
                    const ChartComponent = chart.type === 'line' ? LineChart :
                        chart.type === 'area' ? AreaChart : BarChart;

                    return (
                        <ResponsiveContainer width="100%" height="100%">
                            <ChartComponent data={chart.data} margin={{ top: 20, right: 20, bottom: 20, left: -20 }}>
                                <CartesianGrid stroke="#334155" strokeDasharray="3 3" opacity={0.5} />
                                <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} />
                                <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} />
                                <CommonTooltip />
                                <Legend verticalAlign="top" height={36} iconType="circle" />
                                {chart.type === 'area' ? (
                                    <Area type="monotone" dataKey="value" stroke={colors[0]} fill={colors[0]} fillOpacity={0.3} />
                                ) : chart.type === 'line' ? (
                                    <Line type="monotone" dataKey="value" stroke={colors[0]} strokeWidth={3} dot={{ r: 4 }} />
                                ) : (
                                    <Bar dataKey="value" fill={colors[0]} radius={[4, 4, 0, 0]} />
                                )}
                            </ChartComponent>
                        </ResponsiveContainer>
                    );
            }
        };

        const SectionHeader = ({ icon: Icon, title, color }) => (
            <h3 className={`text-lg font-bold text-white mb-6 border-b border-white/5 pb-4 ${color} uppercase tracking-widest text-xs flex items-center gap-2`}>
                <Icon className="w-4 h-4" /> {title}
            </h3>
        );

        return (
            <div className="space-y-8 animate-in fade-in duration-700">
                {/* Dashboard Header */}
                <div className="bg-gradient-to-r from-indigo-900/20 to-purple-900/20 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                    <div className="flex items-start gap-4">
                        <div className="p-3 bg-indigo-500 rounded-2xl shadow-lg shadow-indigo-500/20">
                            <BarChart2 className="w-8 h-8 text-white" />
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold text-white mb-2">{dashboard_title || "Analytics Dashboard"}</h1>
                            <div className="flex gap-4 mb-3">
                                <span className="px-3 py-1 bg-indigo-500/10 border border-indigo-500/20 rounded-full text-[10px] font-bold text-indigo-400 uppercase tracking-tighter">
                                    {data.dataset_overview?.rows || 0} Records Analyzed
                                </span>
                                <span className="px-3 py-1 bg-purple-500/10 border border-purple-500/20 rounded-full text-[10px] font-bold text-purple-400 uppercase tracking-tighter">
                                    {data.dataset_overview?.columns || 0} Attributes
                                </span>
                            </div>
                            <p className="text-lg text-slate-400 font-light leading-relaxed max-w-4xl line-clamp-3">
                                {typeof scentific_summary === 'string' ? scentific_summary : (scentific_summary?.text || scentific_summary?.summary || "No executive summary available for this dataset.")}
                            </p>
                        </div>
                    </div>
                </div>

                {/* KPI Grid */}
                {kpis.length > 0 && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {kpis.map((kpi, i) => <KPICard key={i} kpi={kpi} />)}
                    </div>
                )}

                {/* Dataset Preview */}
                {content.preview && content.preview.length > 0 && (
                    <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm overflow-hidden">
                        <SectionHeader icon={Layers} title="Dataset Snapshot" color="text-indigo-300" />
                        <div className="overflow-x-auto rounded-xl border border-white/5">
                            <table className="w-full text-left border-collapse min-w-[600px]">
                                <thead>
                                    <tr className="bg-white/5 border-b border-white/10">
                                        {Object.keys(content.preview[0]).map((header, idx) => (
                                            <th key={idx} className="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-wider">{header}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {content.preview.slice(0, 5).map((row, i) => (
                                        <tr key={i} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                                            {Object.values(row).map((val, j) => (
                                                <td key={j} className="px-4 py-3 text-sm text-slate-300 font-light truncate max-w-[200px]">{String(val)}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {content.preview.length > 5 && (
                                <div className="p-3 bg-slate-950/50 text-center">
                                    <p className="text-[10px] text-slate-500 italic uppercase">Showing top 5 of {content.preview.length}+ rows</p>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* Visualization Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 auto-rows-min">
                    {visualizations.map((chart, i) => (
                        <div
                            key={chart.id || i}
                            className={`
                                bg-slate-900/50 border border-white/5 rounded-3xl p-6 backdrop-blur-sm flex flex-col group hover:border-white/10 transition-all
                                ${chart.layout === 'full' ? 'lg:col-span-2 xl:col-span-2' : ''}
                            `}
                        >
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h3 className="text-sm font-bold text-white group-hover:text-indigo-300 transition-colors uppercase tracking-tight">
                                        {chart.title}
                                    </h3>
                                    <p className="text-xs text-slate-400 mt-2 leading-relaxed font-light">
                                        {chart.description}
                                    </p>
                                </div>
                            </div>
                            <div className="h-[300px] w-full">
                                {renderChartContent(chart)}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Extended Analysis Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Insights & Quality */}
                    <div className="space-y-6">
                        {data_quality_audit && (
                            <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                                <SectionHeader icon={CheckCircle2} title="Data Health Audit" color="text-emerald-400" />
                                <div className="flex items-center gap-6">
                                    <div className="relative w-24 h-24 flex items-center justify-center rounded-full border-4 border-emerald-500/20">
                                        <span className="text-2xl font-bold text-white">{data_quality_audit.score}%</span>
                                    </div>
                                    <p className="text-slate-300 text-sm leading-relaxed">{data_quality_audit.details}</p>
                                </div>
                            </div>
                        )}
                        {statistical_insights.length > 0 && (
                            <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                                <SectionHeader icon={Brain} title="Deep Statistical Insights" color="text-purple-400" />
                                <div className="space-y-4">
                                    {statistical_insights.map((stat, i) => (
                                        <div key={i} className="bg-white/5 rounded-2xl p-4 border border-white/5">
                                            <h4 className="text-purple-400 text-[10px] font-bold uppercase tracking-widest mb-1">
                                                {typeof stat === 'object' ? stat.title : 'Discovery'}
                                            </h4>
                                            <p className="text-slate-300 text-sm leading-relaxed">
                                                {typeof stat === 'object' ? stat.text : stat}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Trends & Segmentation */}
                    <div className="space-y-6">
                        {market_trends?.details?.length > 0 && (
                            <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                                <SectionHeader icon={TrendingUp} title="Market & Trend Analysis" color="text-indigo-400" />
                                <div className="space-y-4">
                                    {market_trends.details.map((trend, i) => (
                                        <div key={i} className="bg-white/5 rounded-2xl p-4 border border-white/10">
                                            <h4 className="text-indigo-400 text-[10px] font-bold uppercase tracking-widest mb-1">
                                                {typeof trend === 'object' ? trend.title : 'Pattern'}
                                            </h4>
                                            <p className="text-slate-300 text-sm leading-relaxed italic">
                                                {typeof trend === 'object' ? trend.text : trend}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {segmentation_analysis && (
                            <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                                <SectionHeader icon={Users} title="Segmentation & Classification" color="text-blue-400" />
                                <p className="text-slate-400 text-sm leading-relaxed italic">{segmentation_analysis}</p>
                            </div>
                        )}
                    </div>
                </div>

                {/* Anomalies & Recommendations */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {anomalies.length > 0 && (
                        <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                            <SectionHeader icon={Info} title="Anomalies & Deviations" color="text-orange-400" />
                            <div className="space-y-4">
                                {anomalies.map((anomaly, i) => (
                                    <div key={i} className="p-4 bg-orange-500/5 border border-orange-500/10 rounded-2xl">
                                        <h4 className="text-orange-400 text-[10px] font-bold uppercase tracking-widest mb-1">
                                            {typeof anomaly === 'object' ? anomaly.title : 'Unusual Activity'}
                                        </h4>
                                        <p className="text-slate-300 text-sm leading-relaxed">
                                            {typeof anomaly === 'object' ? anomaly.text : anomaly}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {recommendations.length > 0 && (
                        <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                            <SectionHeader icon={ListChecks} title="Actionable Guidance" color="text-teal-400" />
                            <div className="space-y-4">
                                {recommendations.map((rec, i) => (
                                    <div key={i} className="flex gap-4 p-4 bg-white/5 border border-white/5 rounded-2xl items-start">
                                        <span className="w-8 h-8 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs font-black flex-shrink-0">
                                            {i + 1}
                                        </span>
                                        <div className="pt-1">
                                            <p className="text-slate-300 text-sm leading-relaxed">
                                                {typeof rec === 'object' ? (rec.text || JSON.stringify(rec)) : rec}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const renderAnalysis = () => {
        const data = content.data || {};
        const isVisualize = content.type === 'visualize';
        const isAdvanced = !!data.executive_summary;

        // Fallback or Advanced Mapping
        const summary = isAdvanced ? data.executive_summary : (data.summary || "No summary available.");
        const trends = isAdvanced ? (data.market_trends?.details || []) : (data.trends || []);
        const analysisTrendsOverview = isAdvanced ? data.market_trends?.overview : null;
        const anomalies = data.anomalies || [];
        const recommendations = data.recommendations || [];
        const insights = data.statistical_insights || [];

        // Helper for section headers
        const SectionHeader = ({ icon: Icon, title, color }) => (
            <h3 className={`text-lg font-bold text-white mb-6 border-b border-white/5 pb-4 ${color} uppercase tracking-widest text-xs flex items-center gap-2`}>
                <Icon className="w-4 h-4" /> {title}
            </h3>
        );

        return (
            <div className="space-y-8">
                {/* 1. Executive Summary & Data Health */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className={`${(isAdvanced && data.data_quality_audit) ? 'lg:col-span-2' : 'lg:col-span-3'} bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm`}>
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <BarChart2 className="w-6 h-6 text-teal-400" />
                            {isVisualize ? "Visual Intelligence Brief" : "Executive Enterprise Summary"}
                        </h2>
                        <div className="prose prose-invert max-w-none">
                            <p className="text-slate-300 leading-relaxed text-lg whitespace-pre-wrap font-light">
                                {typeof summary === 'string' ? summary : (summary?.text || summary?.summary || JSON.stringify(summary))}
                            </p>
                        </div>
                        {data.key_features && data.key_features.length > 0 && (
                            <div className="mt-6 flex flex-wrap gap-2">
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-wider py-1">Critical Drivers:</span>
                                {data.key_features.map((feature, i) => (
                                    <span key={i} className="px-3 py-1 bg-slate-800 text-teal-300 text-xs font-bold rounded-full border border-teal-500/20 shadow-sm">
                                        {typeof feature === 'object' ? JSON.stringify(feature) : feature}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Data Quality Report Card (Hide for visualize if not applicable) */}
                    {isAdvanced && data.data_quality_audit && (
                        <div className="bg-gradient-to-b from-slate-900/60 to-slate-950/60 border border-white/10 rounded-3xl p-8 backdrop-blur-sm flex flex-col justify-center items-center text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
                            <h3 className="text-sm font-bold text-indigo-300 uppercase tracking-widest mb-4">Data Health Score</h3>
                            <div className="relative mb-6">
                                <svg className="w-32 h-32 transform -rotate-90">
                                    <circle cx="64" cy="64" r="56" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-slate-800" />
                                    <circle cx="64" cy="64" r="56" stroke="currentColor" strokeWidth="8" fill="transparent"
                                        strokeDasharray={351}
                                        strokeDashoffset={351 - (351 * (parseInt(data.data_quality_audit.score) || 0) / 100)}
                                        className="text-indigo-500 transition-all duration-1000 ease-out"
                                    />
                                </svg>
                                <span className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-3xl font-bold text-white">
                                    {data.data_quality_audit.score || 'N/A'}
                                </span>
                            </div>
                            <p className="text-xs text-slate-400 leading-relaxed max-w-[200px]">
                                {data.data_quality_audit.details || "Completeness and consistency verification complete."}
                            </p>
                        </div>
                    )}
                </div>

                {/* 2. Deep Insights Grid (Only for Data Analysis) */}
                {!isVisualize && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Statistical Insights */}
                        <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                            <SectionHeader icon={Brain} title="Statistical Deep Dive" color="text-indigo-400" />
                            <div className="space-y-4">
                                {insights.length > 0 ? insights.map((insight, i) => (
                                    <div key={i} className="flex gap-4 p-4 rounded-xl bg-slate-950/30 border border-white/5">
                                        <div className="w-1 rounded-full bg-indigo-500 flex-shrink-0" />
                                        <p className="leading-relaxed text-sm text-slate-300">
                                            {typeof insight === 'object' ? (insight.insight || insight.text || insight.label || JSON.stringify(insight)) : insight}
                                        </p>
                                    </div>
                                )) : <p className="text-slate-500 italic text-sm">No statistical patterns identified for this sample.</p>}
                            </div>
                        </div>

                        {/* Market Trends & Segmentation */}
                        <div className="bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm">
                            <SectionHeader icon={BarChart2} title="Trends & Segmentation" color="text-teal-300" />

                            {analysisTrendsOverview && (
                                <div className="mb-6 p-4 bg-teal-500/5 rounded-xl border border-teal-500/10">
                                    <h4 className="text-xs font-bold text-teal-400 uppercase mb-2">Trend Overview</h4>
                                    <p className="text-sm text-slate-300 leading-relaxed">{analysisTrendsOverview}</p>
                                </div>
                            )}

                            {trends.length > 0 ? (
                                <ul className="space-y-3 mb-6">
                                    {trends.map((trend, i) => (
                                        <li key={i} className="flex gap-3 text-slate-300 text-sm">
                                            <span className="text-teal-500 font-bold">•</span>
                                            {typeof trend === 'object' ? (trend.trend || trend.text || trend.label || JSON.stringify(trend)) : trend}
                                        </li>
                                    ))}
                                </ul>
                            ) : <p className="text-slate-500 italic text-sm mb-6">No significant trends detected in given parameters.</p>}

                            {isAdvanced && data.segmentation_analysis && (
                                <div className="pt-4 border-t border-white/5">
                                    <h4 className="text-xs font-bold text-blue-400 uppercase mb-2 tracking-wider">Cluster Analysis</h4>
                                    <p className="text-sm text-slate-400 leading-relaxed italic">
                                        {data.segmentation_analysis}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* --- Visual Intelligence (Charts) --- */}
                {data.visualizations && data.visualizations.length > 0 && (
                    <div className="space-y-6">
                        <SectionHeader icon={BarChart2} title="Visual Dashboards" color="text-emerald-400" />
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            {data.visualizations.map((chart, i) => (
                                <div key={i} className="bg-slate-900/40 border border-white/5 rounded-3xl p-6 backdrop-blur-sm h-[450px] flex flex-col">
                                    <div className="mb-6">
                                        <h4 className="text-white font-bold text-lg">{chart.title}</h4>
                                        <p className="text-slate-400 text-xs mt-1">{chart.description}</p>
                                    </div>

                                    <div className="flex-1 min-h-0">
                                        <ResponsiveContainer width="100%" height="100%" minWidth={0} minHeight={0}>
                                            {chart.type === 'bar' ? (
                                                <BarChart data={chart.data} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#1e293b" />
                                                    <XAxis dataKey="name" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                                    <Tooltip
                                                        contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '12px' }}
                                                        itemStyle={{ color: '#f8fafc' }}
                                                    />
                                                    <Bar dataKey="value" fill={chart.themeColor === 'teal' ? '#14b8a6' : chart.themeColor === 'purple' ? '#a855f7' : chart.themeColor === 'emerald' ? '#10b981' : '#6366f1'} radius={[4, 4, 0, 0]} />
                                                </BarChart>
                                            ) : chart.type === 'line' ? (
                                                <LineChart data={chart.data} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#1e293b" />
                                                    <XAxis dataKey="name" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                                    <Tooltip
                                                        contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '12px' }}
                                                        itemStyle={{ color: '#f8fafc' }}
                                                    />
                                                    <Line type="monotone" dataKey="value" stroke={chart.themeColor === 'teal' ? '#14b8a6' : chart.themeColor === 'purple' ? '#a855f7' : '#6366f1'} strokeWidth={3} dot={{ fill: '#0f172a', strokeWidth: 2, r: 4 }} activeDot={{ r: 6, strokeWidth: 0 }} />
                                                </LineChart>
                                            ) : chart.type === 'scatter' ? (
                                                <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: -20 }}>
                                                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />
                                                    <XAxis type="number" dataKey="x" name="X" stroke="#64748b" fontSize={10} />
                                                    <YAxis type="number" dataKey="y" name="Y" stroke="#64748b" fontSize={10} />
                                                    <Tooltip cursor={{ strokeDasharray: '3 3' }} contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '12px' }} />
                                                    <Scatter name="Data" data={chart.data} fill="#10b981" />
                                                </ScatterChart>
                                            ) : chart.type === 'treemap' ? (
                                                <Treemap
                                                    data={chart.data}
                                                    dataKey="value"
                                                    aspectRatio={4 / 3}
                                                    stroke="#0f172a"
                                                    fill="#6366f1"
                                                >
                                                    <Tooltip contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b' }} />
                                                </Treemap>
                                            ) : chart.type === 'radar' ? (
                                                <RadarChart cx="50%" cy="50%" outerRadius="80%" data={chart.data}>
                                                    <PolarGrid stroke="#1e293b" />
                                                    <PolarAngleAxis dataKey="name" stroke="#64748b" fontSize={10} />
                                                    <PolarRadiusAxis stroke="#64748b" fontSize={10} />
                                                    <Radar name="Value" dataKey="value" stroke="#6366f1" fill="#6366f1" fillOpacity={0.6} />
                                                    <Tooltip contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b' }} />
                                                </RadarChart>
                                            ) : chart.type === 'area' ? (
                                                <AreaChart data={chart.data} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                    <defs>
                                                        <linearGradient id={`color-${i}`} x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="5%" stopColor={chart.themeColor === 'teal' ? '#14b8a6' : '#6366f1'} stopOpacity={0.3} />
                                                            <stop offset="95%" stopColor={chart.themeColor === 'teal' ? '#14b8a6' : '#6366f1'} stopOpacity={0} />
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#1e293b" />
                                                    <XAxis dataKey="name" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                                    <Tooltip
                                                        contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '12px' }}
                                                        itemStyle={{ color: '#f8fafc' }}
                                                    />
                                                    <Area type="monotone" dataKey="value" stroke={chart.themeColor === 'teal' ? '#14b8a6' : '#6366f1'} fillOpacity={1} fill={`url(#color-${i})`} strokeWidth={3} />
                                                </AreaChart>
                                            ) : (
                                                <PieChart>
                                                    <Pie
                                                        data={chart.data}
                                                        cx="50%"
                                                        cy="50%"
                                                        innerRadius={60}
                                                        outerRadius={80}
                                                        paddingAngle={5}
                                                        dataKey="value"
                                                    >
                                                        {chart.data?.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={['#6366f1', '#14b8a6', '#a855f7', '#10b981', '#f59e0b'][index % 5]} />
                                                        ))}
                                                    </Pie>
                                                    <Tooltip
                                                        contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '12px' }}
                                                        itemStyle={{ color: '#f8fafc' }}
                                                    />
                                                    <Legend wrapperStyle={{ fontSize: '10px', paddingTop: '20px' }} />
                                                </PieChart>
                                            )}

                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* 3. Predictive Modeling & Anomalies (Only for Data Analysis) */}
                {!isVisualize && (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Predictive Potential */}
                        {isAdvanced && (
                            <div className="lg:col-span-1 bg-gradient-to-br from-purple-900/20 to-indigo-900/20 border border-white/10 rounded-3xl p-8 backdrop-blur-sm">
                                <SectionHeader icon={Layers} title="Predictive Potential" color="text-purple-400" />

                                {data.predictive_potential ? (
                                    <>
                                        <div className="flex items-center justify-between mb-4">
                                            <span className="text-sm text-slate-400">Model Viability:</span>
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase border ${data.predictive_potential.feasibility === 'High' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' :
                                                data.predictive_potential.feasibility === 'Medium' ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' :
                                                    'bg-red-500/10 text-red-400 border-red-500/20'
                                                }`}>
                                                {data.predictive_potential.feasibility || 'Evaluation Pending'}
                                            </span>
                                        </div>

                                        <p className="text-sm text-slate-300 mb-6 leading-relaxed">
                                            {data.predictive_potential.details}
                                        </p>

                                        <div>
                                            <h4 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Recommended Models</h4>
                                            <div className="flex flex-wrap gap-2">
                                                {data.predictive_potential.recommended_models?.map((m, i) => (
                                                    <span key={i} className="px-2 py-1 bg-purple-500/10 text-purple-300 text-xs rounded border border-purple-500/20">
                                                        {m}
                                                    </span>
                                                )) || <span className="text-xs text-slate-600">No specific models cited.</span>}
                                            </div>
                                        </div>
                                    </>
                                ) : <p className="text-slate-500 italic text-sm">Predictive mapping not requested or applicable for this dataset.</p>}
                            </div>
                        )}

                        {/* Anomalies */}
                        <div className={`${isAdvanced ? 'lg:col-span-2' : 'lg:col-span-3'} bg-slate-900/40 border border-white/5 rounded-3xl p-8 backdrop-blur-sm`}>
                            <SectionHeader icon={Info} title="Anomalies & Outliers" color="text-orange-300" />
                            {anomalies.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {anomalies.map((anomaly, i) => (
                                        <div key={i} className="flex gap-3 text-slate-300 bg-orange-500/5 border border-orange-500/10 p-4 rounded-xl hover:bg-orange-500/10 transition-colors">
                                            <div className="w-1.5 h-1.5 rounded-full bg-orange-500 mt-2 flex-shrink-0" />
                                            <span className="leading-relaxed text-sm">
                                                {typeof anomaly === 'object' ? JSON.stringify(anomaly) : anomaly}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            ) : <p className="text-slate-500 italic text-sm">Data appears uniform; no significant outliers found.</p>}
                        </div>
                    </div>
                )}

                {/* 4. Strategic Recommendations (Only for Data Analysis) */}
                {!isVisualize && (
                    <div className="bg-gradient-to-r from-slate-900 via-indigo-950/30 to-slate-900 border border-white/10 rounded-3xl p-8 backdrop-blur-sm relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-32 bg-indigo-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        <SectionHeader icon={CheckCircle2} title="Strategic Guidance" color="text-white" />

                        {recommendations.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                                {recommendations.map((rec, i) => (
                                    <div key={i} className="p-6 bg-white/5 rounded-2xl border border-white/5 hover:border-indigo-500/30 hover:bg-white/10 transition-all duration-300 group">
                                        <div className="flex gap-4">
                                            <span className="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-500/20 text-indigo-400 font-bold text-sm border border-indigo-500/20 group-hover:scale-110 transition-transform">
                                                {i + 1}
                                            </span>
                                            <p className="text-slate-200 text-base leading-relaxed font-light group-hover:text-white">
                                                {typeof rec === 'object' ? JSON.stringify(rec) : rec}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-slate-500 italic text-sm text-center py-4">Sufficient data not available for strategic extrapolation.</p>}
                    </div>
                )}
            </div>
        );
    };

    return (
        <div className="min-h-screen pt-24 pb-20 px-6 max-w-7xl mx-auto font-outfit">
            <AnimatePresence mode='wait'>
                <motion.div
                    key={content._id}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -20 }}
                >
                    {renderHeader()}

                    <main ref={contentRef} className="bg-[#020617] p-4 -m-4 rounded-xl">
                        {content.type === 'mcq' || content.type === 'quiz' ? renderMCQs() : null}
                        {content.type === 'summary' ? renderSummary() : null}
                        {content.type === 'flashcards' ? renderFlashcards() : null}
                        {(content.type === 'explain' || content.type === 'review') ? renderCodeAnalysis() : null}
                        {content.type === 'visualize' ? renderDataVisualizationDashboard() : null}
                        {content.type === 'analysis' ? renderAnalysis() : null}
                    </main>
                </motion.div>
            </AnimatePresence>
        </div>
    );
};

export default Results;
